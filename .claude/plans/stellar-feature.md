# ステラ機能計画

## 概要

はてなスターをオマージュした「ステラ」機能。
Nostr Zapと連携したカラーステラの経済圏を構築。

## インベントリとスタッツの違い

### 2つの数値

| 項目 | インベントリ | スタッツ |
|------|-------------|----------|
| 意味 | 使える数 | もらった数 |
| 購入時 | **増える** | 増えない |
| 他人からもらう | **増える** | **増える** |
| 他人に与える | 減る | 変わらない |

### インベントリ
- **使えるステラの数**
- 購入分 + もらった分
- 他人に与えると減る
- 由来（購入/受取）は区別しない

### スタッツ
- **他人からもらった数**（社会的な評価指標）
- 購入しても増えない
- 他人に与えても減らない
- GIVERが偉い文化の根拠

## インベントリ（収集要素）

mypaceでは様々なアイテムを「インベントリ」で管理する。
ゲーム的な収集要素を重視し、将来的な拡張を見据えた設計。

### インベントリに入るもの
- **カラーステラ**: 購入したもの、もらったもの
- **実績バッジ**: 達成条件を満たすと獲得（将来）
- **その他アイテム**: 拡張予定

### アイテムの由来
- 買っても、もらっても、実績で獲得しても → 同じインベントリに入る
- **由来は関係なくなる**（所有していることが重要）
- ただし**スタッツは他人からもらった分のみカウント**

## カラーステラの基本フロー

```
Zap購入 → 自分のインベントリ → 他人に与える → 相手の投稿に表示
```

- **Zap購入**: 自分が他人に配るためのカラーステラを買う行為
- **使う**: 他人にカラーステラを与える行為
- **インベントリ**: 買ったものも、もらったものも同じインベントリに入る

## 設計思想

### 承認欲求モンスターを作らない

**問題意識:**
- SNSは「いいね」欲しさにユーザーを暴走させる
- 過激な投稿、炎上商法、承認欲求の奴隷化
- 認められたいのは人間の本能。それ自体は悪くない

**mypaceのアプローチ:**
- 認められるハードルを**極限まで下げる**
- 簡単にステラがつく雰囲気を作る
- **インフレを意図的に起こす**
- どの投稿にも★が1個ついて当たり前の世界

### インフレの設計

```
従来のSNS:
  いいね0 → 普通
  いいね10 → すごい！
  いいね100 → バズった！
  → いいねが欲しくて過激化

mypace:
  ★0 → ほぼない（みんな気軽に付ける）
  ★10 → 普通
  ★100 → 普通
  → ステラは空気のように付くもの
  → 欲しがる必要がない
```

### カラーステラがイエローの障壁を下げる

- カラーステラ（有料・レア）があることで
- イエロー（無料）の価値が相対的に「軽く」なる
- 「無料だし、とりあえず付けておこう」心理
- **気軽に付ける文化**が生まれる

### はてブのスター集めゲーム

- 承認欲求を満たすゲームではない
- **収集ゲーム**として楽しむ
- コレクション要素
- 「紫ステラ持ってる！」という自慢
- ゲーミフィケーションを健全に使う

### GIVERが偉い文化

**Xへのアンチテーゼ:**
```
X/Twitter:
  フォロワー > フォロー = かっこいい
  いいね貰う数が多い = 偉い
  → TAKE文化

mypace:
  あげた数 > もらった数 = かっこいい
  ステラ付与数が多い = 偉い
  → GIVE文化
```

**価値観の転換:**
- 「もらった数」は自慢にならない
- 「あげた数」が多い人が尊敬される
- SUPER GIVER が最高位
- TAKER は恥ずかしい（わけではないが、GIVERが輝く）

**設計の意図:**
- 承認を「もらう」ことに価値を置かない
- 承認を「あげる」行為に価値を置く
- コミュニティ全体が温かくなる
- 「俺はこんなにステラ配った」という健全な自慢

## 基本概念

### イエローステラ（無料）
- 誰でも無制限に付けられる
- 「いいね」相当
- コストなし

### カラーステラ（有料）
- Zapで購入 → 自分のインベントリに追加
- 他のユーザーの投稿に与えられる
- 受け取ったユーザーもインベントリに追加される
- **使っても投稿から消えない**（付けた記録は残り続ける）
- **買ったか、もらったかは関係ない**（インベントリに入れば同じ）

## カラー階級（はてなスター準拠）

5色でシンプルに。10倍刻みの価格設定。

| 色 | Zap (sats) | 概算USD |
|----|------------|---------|
| ★ イエロー | 無料 | $0 |
| ★ グリーン | 1 | ほぼ$0 |
| ★ レッド | 10 | 約$0.005 |
| ★ ブルー | 100 | 約$0.05 |
| ★ パープル | 1,000 | 約$0.50 |

※ 最高額のパープルでも$1未満

## 両替（金種）の概念

カラーステラは「金種（お札の単位）」として機能する。

### 金種としての色

```
パープル = 1000札
ブルー   = 100札
レッド   = 10札
グリーン = 1札
イエロー = 無料（別枠、両替対象外）
```

### 両替の仕組み

高額の色しか持っていない場合、低額の色を使うと自動で両替される。

**例: パープル1個でブルー1個を与える**
```
所持: 1000 sats相当（パープル1個として表示）
 ↓
ブルー1個を使用（100 sats消費）
 ↓
残り: 900 sats相当（ブルー9個として表示）
```

**例: ブルー2個でレッド3個を与える**
```
所持: 200 sats相当（ブルー2個として表示）
 ↓
レッド3個を使用（30 sats消費）
 ↓
残り: 170 sats相当（ブルー1個 + レッド7個として表示）
```

### インベントリの表示

- 端数がない限り、低額の色は表示されない
- 常に最大金種でまとめて表示
- sats総額を色の組み合わせで表現

```
1000 sats → パープル1
1234 sats → パープル1 + ブルー2 + レッド3 + グリーン4
 100 sats → ブルー1
  99 sats → レッド9 + グリーン9
```

### 両替が適用される場所・されない場所

| 場所 | 両替 | 説明 |
|------|------|------|
| インベントリ | ✓ | 金種表示（1000 sats → パープル1） |
| 投稿カードのステラ | ✗ | 実際にもらった色のまま表示 |
| スタッツ | ✗ | 実際にもらった色・個数のまま |

**例: ブルー10個もらった投稿**
- 投稿カード: ★ブルー10個と表示（パープル1にはならない）
- スタッツ: ブルー+10としてカウント
- 受け取り側のインベントリ: +1000 sats（パープル1相当として表示）

## 表示位置まとめ

| 場所 | 配置 |
|------|------|
| 投稿カード | イエローステラの右にカラーステラが並ぶ |
| ユーザーページ stats | イエローステラの右に並ぶ |
| ホーム右下フロート stats | イエローステラの下に並ぶ |

## 表示イメージ

### 投稿のステラ表示

```
┌─ 投稿 ─────────────────────────────────┐
│ @username                              │
│                                        │
│ 今日のランチ美味しかった！              │
│                                        │
│ ★12 ★3 ★2 ★1 ★1                      │
│ (黄) (緑) (赤) (青) (紫) ← 右に並ぶ    │
└────────────────────────────────────────┘
```

### ステラ詳細ポップアップ

```
┌─ ステラ詳細 ─────────────────────────┐
│                                      │
│ ★ イエロー x 12                      │
│   @user1, @user2, @user3...          │
│                                      │
│ ★ グリーン x 3                       │
│   @user4, @user5, @user6             │
│                                      │
│ ★ レッド x 2                         │
│   @user7, @user8                     │
│                                      │
│ ★ ブルー x 1                         │
│   @user9                             │
│                                      │
│ ★ パープル x 1                       │
│   @user10                            │
│                                      │
└──────────────────────────────────────┘
```

## インベントリ画面

### カラーステラのインベントリ

```
┌─ インベントリ ───────────────────────┐
│                                      │
│ カラーステラ残高: 1,234 sats相当      │
│                                      │
│ ★ パープル: 1個 (1000)               │
│ ★ ブルー: 2個 (200)                  │
│ ★ レッド: 3個 (30)                   │
│ ★ グリーン: 4個 (4)                  │
│                                      │
│ ※ 両替は自動（金種として表示）        │
│                                      │
│ [Zapでステラを購入]                   │
└──────────────────────────────────────┘

※ 端数がなければ低額色は表示されない
例: 1000 sats → パープル1個のみ表示
```

### 使用フロー

1. 投稿にステラを付けたい
2. ステラ選択UI表示
3. イエロー（無料）or カラーを選択
4. 投稿に付与（残高から消費、自動両替）

```
┌─ ステラを付ける ─────────────────────┐
│                                      │
│ [★ イエロー] 無料・無制限             │
│                                      │
│ ─ カラーステラ（残高: 1,234 sats）─   │
│ [★ グリーン] 1 sat                   │
│ [★ レッド] 10 sats                   │
│ [★ ブルー] 100 sats                  │
│ [★ パープル] 1,000 sats              │
│                                      │
│ ※ 残高不足の色は灰色・選択不可        │
│                                      │
│ [💰 残高を追加購入]                    │
│                                      │
└──────────────────────────────────────┘
```

**使用例: 残高1000でブルー1個を付ける**
```
残高: 1000 sats（パープル1個相当）
 ↓ ブルー1個を選択
消費: 100 sats
残高: 900 sats（ブルー9個相当に自動両替）
```

## データ構造

### ステライベント（Kind 7 リアクション拡張）

現在の実装を拡張し、色情報を追加する。

**現在の形式（イエローのみ）:**
```json
{
  "kind": 7,
  "content": "+",
  "tags": [
    ["e", "<post_id>"],
    ["p", "<author_pubkey>"],
    ["stella", "5"]
  ]
}
```

**拡張形式（カラー対応）:**
```json
{
  "kind": 7,
  "content": "+",
  "tags": [
    ["e", "<post_id>"],
    ["p", "<author_pubkey>"],
    ["stella", "yellow", "5"],
    ["stella", "blue", "2"],
    ["stella", "purple", "1"]
  ]
}
```

### 後方互換性

```
["stella", "5"]        → イエロー5個（色指定なし = イエロー）
["stella", "yellow", "5"] → イエロー5個（明示的）
["stella", "purple", "1"] → パープル1個
```

古いイベントがリレーに残り続けるため、色指定なしをイエローとして扱う処理は永久に必要。

### Zap Receiptとの紐付け

**紐付けは不要**

- ステライベントの存在 = その色のステラを付けた証拠
- Zap Receipt（kind 9735）との関連付けは行わない
- 偽造可能だが、少額なので厳密に管理しない
- シンプルさを優先

## UI実装

### ステラボタン

現在の「いいね」ボタンを拡張:

```
[★12] [★3緑] [★2赤] [★1青] [★1紫]   [+ステラ]
                              ↑
                         クリックで選択UI
```

### ステラ付与アニメーション

- 黄: シンプルに追加
- カラー: キラキラエフェクト + sats表示
- 紫: 特別な演出（冠が降ってくる等）

## ステラ必須記事（ペイウォール）機能

### 概要

長文投稿を「ステラ必須記事」として設定できる機能。
指定したステラを与えない限り、全文を読むことができない。

### イエローステラも対象

- **イエローステラ（無料）** でも設定可能
- カラーステラだけでなく、イエロー1個でアンロックも選べる
- 無料で機能を体験・練習できる
- ハードルを下げてペイウォール文化に慣れてもらう

### 折りたたみルール

- 既存の折りたたみ機能（281文字以上で自動折りたたみ）をそのまま利用
- 有料記事専用の折りたたみ処理は追加しない

### 有料記事の設定

投稿時に「ステラ必須」を選択し、必要なステラを指定：

```
┌─ 投稿作成 ──────────────────────────────┐
│                                         │
│ [本文入力エリア]                         │
│ 今日は特別なレシピを紹介します...        │
│ (320文字)                               │
│                                         │
├─────────────────────────────────────────┤
│ ☑ ステラ必須にする                       │
│                                         │
│ アンロックに必要なステラ:                │
│ ○ ★ イエロー (無料)  ← 練習に最適      │
│ ○ ★ グリーン (1 sat)                   │
│ ○ ★ レッド (10 sats)                   │
│ ○ ★ ブルー (100 sats)                  │
│ ● ★ パープル (1,000 sats) ← 選択中    │
│                                         │
│ [投稿]                                   │
└─────────────────────────────────────────┘
```

### ステラ必須記事の表示

タイムライン上での表示：

```
┌─ 投稿（紫ステラ必須）──────────────────┐
│ @username                              │
│                                        │
│ 今日は特別なレシピを紹介します。        │
│ まず材料から...                         │
│                                        │
├─────────────────────────────────────────┤
│ ▼ 続きを読む              🔒★          │
│                     （紫の錠前アイコン） │
└────────────────────────────────────────┘

┌─ 投稿（イエローステラ必須）─────────────┐
│ @username                              │
│                                        │
│ ちょっとした実験投稿です。              │
│ 続きは...                               │
│                                        │
├─────────────────────────────────────────┤
│ ▼ 続きを読む              🔒★          │
│                   （黄色の錠前アイコン） │
└────────────────────────────────────────┘
```

- 折りたたみの右に**錠前アイコン**が表示される
- 錠前の色 = 必要なステラの色（イエロー含む）

### アンロック条件

- **必要なステラは常に1個**（色で価値を表現）
- イエロー = 無料、カラー = sats相当の価値
- その記事に指定ステラを与えるとアンロック
- **一度アンロックしたら永久に読める**

### アンロック済み判定

- DBなしで判定（Nostrイベントベース）
- 自分がその記事に指定ステラ（イエロー or カラー）を付けた履歴を確認
- 付けた記録があれば展開可能

### セキュリティについて

- 折りたたみ展開後の文字列はクライアントに既に取得されている
- デベロッパーツールを使えばステラなしで読める可能性がある
- **それでOK**（そこまでして読みたいなら読めばいい）
- 厳密なDRMではなく、UX上のソフトな制限
- 防げるなら防ぐが、完璧でなくてよい

### 投稿者のルール

- **ステラを持っていなくても要求できる**
  - インベントリ0でもパープル要求の投稿を作れる
- **投稿削除**: 読めなくなる（それでOK）
- **再投稿**: IDが変わるので再度ステラが必要（仕方ない）

### 要求レベルの変更

投稿後にステラ要求を変更したいケース:
- パープル → グリーンに値下げ
- 古い記事なので無料に変更
- 無料 → 有料化（逆もあり得る）

**理想**: IDを変えずに変更できる

### 実装方式

**Nostrタグで実装する**（DBは使わない）

- 投稿の4隅の色、ステッカーと同様にtagsで実現
- DBに頼りすぎるとNostrの意味が薄れる
- 変更したい場合は再投稿（IDが変わる）

```json
{
  "kind": 1,
  "content": "...",
  "tags": [
    ["mypace", "paywall", "blue"]  // ブルー必須
  ]
}
```

### エッジケースの方針

| ケース | 対応 |
|--------|------|
| 値上げ後、既存の開放者 | 読める（一度開放したら永久） |
| 値下げ後、高額で払った人 | ケアしない（早期アクセスに価値） |
| 返金 | しない（少額、複雑化を避ける） |

**基本思想**: 少額なので厳密な管理はしない。シンプルに保つ。

### アンロックのフロー

```
1. ユーザーがステラ必須記事をクリック
2. 「この記事を読むには★(色)が必要です」表示
3. ユーザーが指定ステラを付ける
   - イエロー: 無制限（いつでも付けられる）
   - カラー: インベントリから消費
4. 投稿者にステラが付与される
5. 記事がアンロックされ、全文表示
6. 以降は常に全文表示される
```

### アンロック後の表示

```
┌─ 投稿（アンロック済み）────────────────┐
│ @username                              │
│                                        │
│ 今日は特別なレシピを紹介します。        │
│ まず材料から...                         │
│                                        │
│ [全文が展開表示される]                  │
│                                        │
│ ★12 ★3 ★2 ★1 ★1                      │
└────────────────────────────────────────┘
```

## 実装優先度

1. イエローステラ（現在のいいねを変更）
2. ステラカウント表示
3. カラーステラ表示
4. Zap購入フロー（NIP-57）
5. 所有ステラ管理（インベントリ）
6. 所有ステラの使用（他人に与える）
7. 有料記事（ペイウォール）機能

## はてなスターとの違い

| 機能 | はてな | mypace |
|------|--------|--------|
| 無料スター | 黄のみ | 黄のみ |
| 有料スター | 課金 | Zap (Lightning) |
| 色の意味 | 希少性 | はてなスター準拠 |
| もらったスター | 使えない | 使える |
| 分散型 | ✗ | ✓ |

## Zap連携の設計

### 基本方針: ノンカストディアル

- **MY PACEはsatsを預からない**
- 各ユーザーが自分のLightningウォレット（Alby等）で管理
- 余ったsatsは他のNostrクライアントでZapとして使ってもOK

### インベントリ = ウォレット残高

```
ユーザーのLightningウォレット残高: 1234 sats
↓
MY PACE上のインベントリ表示:
★ パープル: 1個 (1000)
★ ブルー: 2個 (200)
★ レッド: 3個 (30)
★ グリーン: 4個 (4)
```

- **購入という概念がない**: 既にsatsを持っていればそれがステラ
- **他で使える**: MY PACE以外でZapしても残高が減るだけ
- **他で増える**: 他クライアントでZapをもらえばインベントリも増える

### ステラを与えるフロー

```
1. ユーザーがステラを付けたい
2. 色を選択（例: ブルー = 100 sats）
3. Lightningウォレットから相手に100 sats支払い
4. ステライベント（kind 7 + mypaceタグ）発行
5. 相手の投稿にステラ表示
6. 相手のウォレット残高 +100 sats（= インベントリ増加）
```

### 必要な連携

- Lightningウォレット連携（Alby API、NWC等）
- ウォレット残高の取得 → インベントリ表示
- 支払い実行 → ステラ付与

### メリット

- MY PACEが資金を預からない（ノンカストディアル）
- satsは汎用的に使える（MY PACE専用通貨ではない）
- 他クライアントとの相互運用性

## プロフィールのステラ統計

### キルレシオ風の表示

FPSゲームのK/D比のように、あげた数ともらった数を表示。

```
┌─ ステラ統計 ─────────────────────────┐
│                                      │
│  もらった ★ 1,234    あげた ★ 5,678  │
│                                      │
│        GIVE/TAKE RATIO               │
│            4.60                      │
│         ████████░░                   │
│          GIVER型                     │
│                                      │
│  ─────────────────────────────────   │
│                                      │
│  カラー内訳:                          │
│  ★ グリーン: もらった 50 / あげた 80 │
│  ★ レッド: もらった 20 / あげた 45   │
│  ★ ブルー: もらった 5 / あげた 12    │
│  ★ パープル: もらった 1 / あげた 3   │
│                                      │
└──────────────────────────────────────┘
```

### ユーザータイプ判定

| Ratio | タイプ | 説明 |
|-------|--------|------|
| 0.0-0.5 | TAKER | もらう専門 |
| 0.5-0.8 | BALANCED- | やや受け身 |
| 0.8-1.2 | BALANCED | バランス型 |
| 1.2-2.0 | BALANCED+ | やや積極的 |
| 2.0-5.0 | GIVER | あげる方が多い |
| 5.0+ | SUPER GIVER | 太っ腹 |

### 面白い統計案

```
┌─ ステラ実績 ─────────────────────────┐
│                                      │
│ 📊 総合統計                           │
│                                      │
│ ★ 総獲得: 1,234                      │
│ ★ 総付与: 5,678                      │
│ 📈 G/T比: 4.60 (SUPER GIVER)         │
│                                      │
│ 🏆 実績                              │
│ ・最も付けた相手: @friend (234個)    │
│ ・最も貰った相手: @mentor (156個)    │
│ ・1日最多付与: 89個 (2025/03/15)     │
│ ・連続付与日数: 42日                 │
│                                      │
│ 💎 カラーステラ                       │
│ ・紫を付けた回数: 5回                │
│ ・紫をもらった回数: 2回              │
│ ・最高額ステラ: 紫 (10,000 sats)     │
│                                      │
└──────────────────────────────────────┘
```

### ランキング要素

- GIVER ランキング（最も多くあげた人）
- 紫ステラ保有者ランキング
- 連続付与日数ランキング

## 画面右下のステラ実績表示

Roblox BrainRot風の大きな数字表示。

### 表示イメージ

```
                              ┌──────────────┐
                              │  ★ 2.4K      │ ← イエロー
                              │              │
                              │  ★ 156 (緑)  │ ← カラーは
                              │  ★ 23 (赤)   │    イエローの
                              │  ★ 5 (青)    │    下に並ぶ
                              │  ★ 1 (紫)    │
                              │          [↗] │ ← インベントリへ
                              └──────────────┘
```

### 常時表示

- 画面右下に固定表示
- 自分が今まで獲得したステラ総数（スタッツ）
- **イエローが上、カラーはその下に並ぶ**
- 大きなフォントでインパクト
- **右下にインベントリへの遷移ボタン**

## インベントリ画面

**画面遷移で表示**（ポップアップではない）
アップロード済み画像管理画面と同様の考え方。

### 導線

```
ホーム右下フロート [↗] → /inventory へ遷移
SETTINGS > ACCOUNT → /inventory へのリンク
```

### インベントリ画面のUI

```
┌─ インベントリ ───────────────────────┐
│                                      │
│ カラーステラ残高: 1,234 sats    [+]  │
│                                      │
│ ★ パープル: 1個 (1000)               │
│ ★ ブルー: 2個 (200)                  │
│ ★ レッド: 3個 (30)                   │
│ ★ グリーン: 4個 (4)                  │
│                                      │
│ ※ Lightningウォレット残高を表示      │
│                                      │
└──────────────────────────────────────┘
```

### [+] ボタンの動作

外部ウォレットへ誘導（2つ並列表示）：

```
┌─ satsを追加 ─────────────────────────┐
│                                      │
│ satsを追加するには、                  │
│ Lightningウォレットをご利用ください   │
│                                      │
│ [Alby]  [Wallet of Satoshi]          │
│                                      │
│ ※ MY PACEは決済を行いません          │
│                                      │
└──────────────────────────────────────┘
```

- どちらがメジャーか不明なので並列表示
- 両方とも同じサイズのボタン

### SETTINGS > ACCOUNT での設定

- Lightningウォレット連携（Alby / NWC）
- Lightning Address設定
- インベントリ画面へのリンク

### 数字の単位

| 数 | 表示 |
|----|------|
| 1,234 | 1.2K |
| 12,345 | 12.3K |
| 123,456 | 123K |
| 1,234,567 | 1.2M |
| 1,234,567,890 | 1.2B |
| 1,234,567,890,000 | 1.2T |

### アニメーション

- 新しいステラが来たら数字がカウントアップ
- 紫ステラが来たら特別なエフェクト
- 定期的にキラキラ演出

### CSS/実装

```tsx
function StellarStats() {
  const stats = useStellarStats()  // 自分の獲得ステラ

  return (
    <div className="stellar-stats-overlay">
      <div className="stellar-total">
        <span className="stellar-icon">★</span>
        <span className="stellar-count">{formatNumber(stats.yellow)}</span>
      </div>
      <div className="stellar-colors">
        <div className="stellar-green">★ {stats.green}</div>
        <div className="stellar-red">★ {stats.red}</div>
        <div className="stellar-blue">★ {stats.blue}</div>
        <div className="stellar-purple">★ {stats.purple}</div>
      </div>
    </div>
  )
}
```

```css
.stellar-stats-overlay {
  position: fixed;
  bottom: 1rem;
  right: 1rem;
  font-family: var(--font-display);
  text-align: right;
  z-index: 100;
}

.stellar-total {
  font-size: 3rem;
  font-weight: bold;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
}

.stellar-count {
  background: linear-gradient(to bottom, #ffd700, #ffaa00);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}
```

## 目的の明確化

**目的はゲームとして楽しむこと:**
- 金額は関係ない（大した額にならない）
- 無料より貴重性があって嬉しい
- みんなで遊べる
- 実績として誇れる

**mypace運営への収益ではない:**
- Zapは投稿者に行く
- 運営は手数料を取らない
- 純粋なコミュニティゲーム

## 注意点

- Zapの実装が必要（NIP-57）
- Lightning Walletとの連携
- ステラの永続性（削除不可）
- ステラの色と価格の説明をユーザーに提供
