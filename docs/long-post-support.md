# 長文投稿対応

## 概要

mypaceで長文投稿をサポートしつつ、他のNostrクライアントのユーザーに迷惑をかけない設計。

## なぜ必要か

### mypaceの思想

mypaceは「マイペースに書く」ためのクライアント。Twitterのような短文SNSの空気に流されず、じっくり考えを綴れる場所を目指している。そのため長文投稿のサポートは必須。

### Nostrの現状

- **Kind 1（短文ノート）**: 全クライアント対応、編集不可
- **Kind 30023（長文記事）**: 対応クライアント少、編集可能

Kind 30023を使えば長文は書けるが、読者が限られる。mypaceは「SNSの膨大なユーザーにリーチしつつ、長文も書ける」を実現したい。

### 他のNostrユーザーへの配慮

Kind 1のタイムラインに長文が流れると迷惑になる。プレビュー+リンクの形式にすることで：
- 他のクライアントでは短いプレビューのみ表示
- 興味を持った人だけがmypaceで全文を読める
- SNSの流れを邪魔しない

## SNSとブログの橋渡し

### ブログ作者の視点

mypaceがKind 30023（ブログ記事）を表示し、SNSユーザーがスターやコメントを付けられるようにすることについて：

**歓迎される理由:**
- 予想外の読者からの反応は励みになる
- リーチが広がる = 書いた甲斐がある
- SNSでバズれば新規読者獲得のチャンス
- Nostrの思想「オープンなプロトコル」に合致
- 閉じたブログプラットフォームより開かれている

**懸念点:**
- 記事を読まずに表面的なコメントが来る可能性
- 文脈を理解しない批判
- ただしこれはNostr全体の特性（誰でも誰にでも返信可能）

**結論:**
- 基本的に歓迎されると考えられる
- 「SNSとブログの橋渡し」はNostrの強みを活かす形
- mypaceがその役割を担うことに価値がある

## Nostrとの関係

### 独自拡張の方針

- **foldタグ**: mypace独自仕様だが、Nostrのタグ構造に従う
- 他のクライアントはfoldタグを無視するだけで害はない
- 将来的に他のクライアントが採用する可能性も考慮
- Nostrの「クライアント独自機能はタグで実現」という慣習に従う

### Kind 30023との共存

- mypaceはKind 1とKind 30023の両方を取得・表示
- ブログクライアントで書かれた記事もタイムラインに混在
- SNSとブログの境界を曖昧にする

## 閾値

**280文字** を統一閾値とする（Twitter/X基準）。

この値は以下の3つの場面で共通:
1. 投稿時にfoldタグに分割する文字数
2. エディタで「折りたたまれます」警告を表示する文字数
3. 他クライアント投稿をGUI側で切り詰める文字数

## 投稿時の処理

### 280文字以下の場合

通常通りKind 1として投稿:

```json
{
  "kind": 1,
  "content": "短い投稿内容",
  "tags": [
    ["t", "mypace"],
    ["client", "mypace"]
  ]
}
```

### 280文字超の場合

Kind 1として投稿するが、contentを分割してfoldタグを使用:

```json
{
  "kind": 1,
  "content": "最初の280文字...\n\n...READ MORE → https://mypace.app/post/{event_id}",
  "tags": [
    ["t", "mypace"],
    ["client", "mypace"],
    ["mypace", "fold", "281文字目以降の本文すべて"]
  ]
}
```

**ポイント:**
- `content` には最初の280文字 + READ MOREリンクのみ
- 続きは `["mypace", "fold", "..."]` タグに格納
- 他のNostrクライアントではcontent部分のみ表示される
- READ MOREリンクをクリックするとmypaceの個別ページに飛ぶ

## 表示時の処理

### タイムライン表示

| 投稿の種類 | foldタグ | 処理 |
|------------|----------|------|
| mypace長文投稿 | あり | contentをそのまま表示（既に280字+リンク） |
| 他クライアントの短文 | なし | contentをそのまま表示 |
| 他クライアントの長文 | なし | GUI側で280文字に切り詰め + READ MORE表示 |
| Kind 30023ブログ記事 | なし | GUI側で280文字に切り詰め + READ MORE表示 |

**タイムライン表示ロジック:**
```typescript
if (hasFoldTag(event)) {
  // contentをそのまま表示（既に適切なサイズ）
} else if (content.length > 280) {
  // GUI側で切り詰め + READ MORE表示
} else {
  // そのまま表示
}
```

### 個別ページ表示

| 投稿の種類 | foldタグ | 処理 |
|------------|----------|------|
| mypace長文投稿 | あり | content末尾のリンク除去 + foldタグ内容を結合して全文表示 |
| 他クライアントの投稿 | なし | contentをそのまま全文表示 |
| Kind 30023ブログ記事 | なし | contentをそのまま全文表示 |

**個別ページ表示ロジック:**
```typescript
if (hasFoldTag(event)) {
  const foldContent = getFoldContent(event.tags)
  const baseContent = removeReadMoreLink(event.content)
  return baseContent + foldContent
} else {
  return event.content
}
```

## エディタでの警告

投稿フォームで280文字を超えた場合:
- 文字数カウントの色を変える（警告色）
- 「280文字を超えると折りたたまれます」等のメッセージ表示
- プレビューで実際の分割結果を確認可能

## Kind 30023対応

### 取得

APIでKind 1に加えてKind 30023も取得:
```typescript
kinds: [1, 30023]
```

### 表示

Kind 30023はブログ記事形式:
- タイトル（`title`タグ）があれば表示
- 本文は280文字で切り詰め
- 記事アイコン等で区別表示

## 実装タスク

### Phase 1: 表示対応

- [ ] Kind 30023の取得をAPIに追加
- [ ] タイムラインでKind 1とKind 30023を混在表示
- [ ] foldタグの検出関数追加 (`hasFoldTag`, `getFoldContent`)
- [ ] タイムライン: foldタグ有無で表示分岐
- [ ] 個別ページ: foldタグ結合処理
- [ ] GUI側の切り詰め閾値を420→280に変更

### Phase 2: 投稿対応

- [ ] 280文字超で自動分割 + foldタグ生成
- [ ] content末尾にREAD MOREリンク追加
- [ ] エディタに280文字超警告表示
- [ ] プレビューで分割結果を確認可能に

### Phase 3: UX改善

- [ ] Kind 30023記事の区別表示（アイコン等）
- [ ] 長文プレビューのスタイリング
- [ ] 投稿フォームの文字数警告UI

## 参考: Nostr Kind番号

| Kind | 用途 | 特徴 |
|------|------|------|
| 1 | 短文ノート | 編集不可、全クライアント対応 |
| 30023 | 長文記事 | 編集可能、対応クライアント少 |

## 注意点

- foldタグはmypace独自仕様（他クライアントは無視）
- READ MOREリンクのドメインはデプロイ先に合わせる
- 将来的にfoldタグが他のクライアントでも採用される可能性を考慮
