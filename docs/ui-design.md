# UI Design Philosophy

## Core Principles

### 1. 枠を意識させない (Borderless)
- 枠線や囲みは一切使わない
- 色の違いのみで領域を区別
- 背景色: `#f8f8f8` (ベース) → `#fff` (カード)

### 2. 滑らかな遷移 (Seamless Transitions)
- View Transitions API でページ遷移をアニメーション化
- ユーザーに「遷移した」と感じさせない
- FF4のメニュー画面のように自然にカードが移動

### 3. 軽量・高速 (Lightweight)
- Google Fonts は1種類のみ (BIZ UDGothic)
- システムフォントをフォールバック
- 最小限のCSS
- CSSは `color-mix()` を活用したテーマ変数で管理

## Typography

| 用途 | フォント | Weight |
|------|---------|--------|
| ロゴ | BIZ UDGothic | 700 (Bold) |
| 本文 | BIZ UDGothic | 400 (Regular) |
| UI | BIZ UDGothic | 400-700 |

### ロゴ
```
MY★
PACE
```
- 2行、左詰め
- 太字ゴシック (weight: 700)
- アウトラインテキスト（1pxストローク）
- どのブラウザでも同じ見た目

## Icons

Lucide Icons を使用。絵文字からベクターアイコンに移行:

| アイコン | 用途 |
|---------|------|
| `Star` / `StarOff` | いいね |
| `Repeat2` | リポスト |
| `MessageCircle` | 返信 |
| `Share2` | 共有 |

アイコンはテキストと縦方向に揃えて配置 (`vertical-align: middle`)。

## Buttons

### 八角形デザイン
全てのボタンに45度の角カット（八角形）を適用:

```css
--btn-corner: 10px;
clip-path: polygon(
  var(--btn-corner) 0%, calc(100% - var(--btn-corner)) 0%,
  100% var(--btn-corner), 100% calc(100% - var(--btn-corner)),
  calc(100% - var(--btn-corner)) 100%, var(--btn-corner) 100%,
  0% calc(100% - var(--btn-corner)), 0% var(--btn-corner)
);
```

### ラベル
- 全て大文字 (BACK, POST, CLEAR ALL 等)
- ホバー時に右方向へ微移動 (`translateX(4px)`)

## Colors

CSSカスタムプロパティで5つの基本色を定義し、`color-mix()` で派生色を生成:

### 基本色 (ライトテーマ)
| 変数 | 色 | 用途 |
|------|-----|------|
| `--bg-base` | `#f8f8f8` | ページ背景 |
| `--surface-primary` | `#ffffff` | カード背景 |
| `--surface-secondary` | `#eeeeee` | 非選択ボタン等 |
| `--text-primary` | `#333333` | 本文テキスト |
| `--text-muted` | `#888888` | 補助テキスト |

### 派生色 (color-mix)
```css
--surface-hover: color-mix(in srgb, var(--surface-secondary) 70%, var(--text-muted) 30%);
--border-color: color-mix(in srgb, var(--surface-secondary) 50%, var(--text-muted) 50%);
```

### セマンティック色
| Element | Color |
|---------|-------|
| Error | `#c44` |
| Success | 緑系 |
| Link | 青紫系 |

## Animation

### Card Appearance
- フェードイン + 上方向から移動
- スタガー効果 (順番に出現)
- `animation-delay`: 0s, 0.03s, 0.06s...

### Hover
- カードが右に微妙に移動 (`translateX(4px)`)
- 背景色が微妙に変化

### Page Transition
- View Transitions API
- フェードアウト (上に移動) → フェードイン (下から移動)
- Duration: 0.3s

### ロゴ星アニメーション
- 初回: 2秒後に1回転
- 以降: 42秒周期で回転

### アクションボタン星アニメーション
- いいねボタンの星が42秒周期で回転
- 各投稿カードごとにランダムな遅延（0〜42秒）
- 同期しないように設計

### アバターアニメーション
- 90秒周期でランダムに発動
- 3種類: パルス（拡大縮小）、バウンス（上下）、ウインク（横に縮む）
- 各アバターごとにランダム選択

### Loadingオーバーレイ
- 星アイコンが4秒周期で回転
- 背景がパルスアニメーション（3秒周期で1.05倍に拡大縮小）
- **テキスト色**: 4隅のテーマカラーに基づいて自動調整
  - 4隅のうち2つ以上が暗い色 → 白文字・白星
  - それ以外 → 黒文字・黒星
  - 投稿カードの本文色と同じアルゴリズム（`isDarkColor`関数）
- テーマカラー未設定時はアプリテーマ（ライト/ダーク）に従う

### コンテンツアニメーション
- **リンク**: 59秒周期でシマー効果（左から右へ光が流れる）
- **ハッシュタグ**: 47秒周期でキラッと光る
- 素数周期で最小公倍数を最大化（同期しにくい）

## Interaction

- フォーカス時にフォームが浮き上がる (box-shadow)
- ボタンは押すと縮む (`scale(0.98)`)
- 設定パネルはスライドで開く
- ロゴクリックでトップへ遷移（選択不可）

## Timeline Layout

### マソンリーレイアウト
CSS Columns を使用したマソンリー（レンガ積み）レイアウト:
- PC: 3カラム
- タブレット: 2カラム
- スマホ: 1カラム

```css
.timeline-list {
  column-count: 3;
  column-gap: 16px;
}
```

### 投稿カードデザイン

#### 折れ角 (Folded Corner)
カード右上に折れた紙の角を演出:
```css
.post-card::before {
  /* 三角形の角 */
  clip-path: polygon(0 0, 100% 100%, 100% 0);
  background: var(--bg-base);
}
```

#### ホバーエフェクト
- 右方向へ微移動 (`translateX(4px)`)
- 折れ角の影が濃くなる

#### 投稿者名のローディング演出
プロフィール読み込み中（約0.5秒）は投稿者名に虹色アニメーションを適用:
- 黒縁のアウトラインは維持したまま、文字の塗りつぶし部分が虹色グラデーションでアニメーション
- 左から右へ流れる虹色（赤→黄→水色→ピンク→青→紫）
- 1秒周期でループ
- プロフィール確定後は通常の白い縁取り文字に切り替わる
- プロフィール未設定ユーザーは短縮npub（`npub1234...5678`）で表示

## Post Form

- 左下に固定配置
- プレースホルダー: 「マイペースに書こう」
- 文字数制限: 4200文字
- **上部（右寄せ）**:
  - 📷ボタン: 画像アップロード（クリックまたはドラッグ&ドロップ）
  - LONGボタン: 長文モードへ切り替え
- **テキストエリア**:
  - 右端中央に×ボタン（クリアボタン）: テキストがある時のみ表示、即座に全削除
- **下部**:
  - Previewボタン: Markdown/画像URL/リンクの表示確認
  - 文字数カウント
  - Postボタン
- プレビューには自分のテーマカラーが適用される
- 📷ボタン詳細:
  - nostr.buildにNIP-98認証でアップロード
  - アップロード後、URLが本文に挿入される
  - 添付画像はサムネイル表示、×ボタンで削除可能
- 透過効果: 非アクティブ時は少し透明（opacity: 0.9）
  - ホバー、フォーカス、テキスト入力中は不透明に
- **モバイル対応**: 狭い画面では`max-width: calc(100vw - 1rem)`で画面内に収まる

### 長文モード
- 右上の「LONG」ボタンで切り替え（短文モードでは上部右寄せ配置）
- 長文モードに入ると**自動でプレビューON**
- 「SHORT」ボタンは画面**左下固定**（プレビューボタンと被らない位置）
- **レイアウト**:
  - PC（961px以上）: 左右2分割（左: エディタ、右: プレビュー）
  - スマホ/タブレット（960px以下）: 上下2分割（上: エディタ、下: プレビュー）
- **プレビューOFF時**: エディタが画面中央に配置（max-width: 700px）
- プレビューボタン（PREVIEW/HIDE）は短文モードと同じ位置（post-actions内）
- タイムラインは非表示になり、画面全体を使用
- 「SHORT」で短文モードに戻る（プレビューも自動OFF）

#### CodeMirror 6エディタ
- 長文モード専用のリッチエディタ
- **機能**:
  - Markdownシンタックスハイライト
  - 行番号表示
  - 括弧マッチング・自動補完
  - 現在行ハイライト
  - 選択テキストマッチハイライト
  - コード折りたたみ
  - 検索/置換（Ctrl+F, Ctrl+H）
  - Tabインデント
  - 矩形選択（Alt+ドラッグ）
- **Vimモード**: エディタ右上のトグルで切り替え（localStorageに保存）
  - `:w` - 投稿（POSTボタンと同じ）
  - `:q` - 長文モード終了（SHORTボタンと同じ）
  - `:wq` - 投稿して長文モード終了
  - ステータスパネル表示（画面下部、緑色）
- **フォント**: 投稿カードと同じ等幅フォント（BIZ UDGothic）

## Feedback Messages

操作成功時はインラインで緑色メッセージを2秒間表示:
- プロフィール更新: `Updated!`
- 投稿編集保存: `Saved!`
- 投稿削除: `Deleted!`

## Post Actions

アクションボタン（いいね、返信、リポスト、シェア）は半透明白背景（`rgba(255,255,255,0.5)`）の角丸ボタンとして表示。これによりどのテーマ色でも視認可能。

### いいね（NIP-25 kind 7）
- 星アイコン（☆/★）でいいね操作
- 自分の投稿にはいいね不可（ボタン非表示、カウントのみ表示）
- いいね済みは金色の★で表示

### 返信（NIP-10）
- 返信ボタンで投稿フォームが返信モードに切り替わる
- 「Replying to post...」ラベル表示、緑枠
- スレッド形式で返信を表示（インデント付き）
- 自分への返信も可能

### リポスト（NIP-18 kind 6）
- リポストボタンで再投稿
- タイムラインに「🔁 ○○ reposted」ラベル付きで表示
- 元の投稿とリポストは両方タイムラインに表示される
- 自分の投稿もリポスト可能

### 共有（↗ボタン）
- Web Share API対応（モバイル等でネイティブ共有メニュー）
- 非対応ブラウザではクリップボードにURLコピー
- 投稿カードと個別投稿ページで利用可能
- タグフィルター時はフィルターURLを共有可能

### 編集・削除
- 自分の投稿のみ「Edit」「Delete」ボタン表示（右下寄せ）
- Edit押下で投稿フォームに内容を読み込み編集モードへ
- 編集モード: 投稿フォームに「Editing post...」ラベル表示、青枠
- 返信の編集時は返信タグを保持（NIP-10 e/pタグ）
- Delete押下で確認UI表示（ブラウザアラート不使用）
  - `Delete? Yes No` のインライン確認（投稿カード内）
- 編集は delete + 新規投稿の2ステップ（Nostr仕様）

## RESTful URLs

静的URLでタイムラインの状態を共有可能:

| URL | 内容 |
|-----|------|
| `/` | タイムライン（mypace投稿） |
| `/?mypace=off` | タイムライン（全投稿、mypaceフィルタOFF） |
| `/?q=keyword` | キーワード検索 |
| `/?tags=tag1+tag2` | タグフィルタ（AND） |
| `/?tags=tag1,tag2` | タグフィルタ（OR） |
| `/?ng=word1,word2` | NGワードフィルタ |
| `/?ngtags=tag1,tag2` | NGタグフィルタ |
| `/post/{event_id}` | 個別投稿ページ（大きめカード表示） |
| `/tag/{hashtag}` | ハッシュタグフィルタ（レガシー、`/?tags=`にリダイレクト相当） |
| `/user/{pubkey}` | ユーザーページ（プロフィール+投稿一覧） |

### 個別投稿ページ
- 投稿カードクリックで遷移（ボタン・リンク以外の領域）
- 大きめカードで全文表示
- テーマカラー背景適用
- 返信一覧表示

### ユーザーページ
- ユーザー名/アバタークリックで遷移
- バナー画像（3:1アスペクト比、横幅いっぱい）
- プロフィールカード（右上配置、max-width: 600px）
  - アバター（バナー下端に重ねて配置）
  - 名前、NIP-05認証マーク
  - 自己紹介（about）
  - Webサイトリンク、Lightning Address
  - npub全文表示 + コピーボタン
  - 投稿数
- 自分のプロフィールページでは「EDIT」ボタン表示
  - クリックで編集モードに切り替え
  - バナー・アバター画像アップロード
  - 各フィールドの編集フォーム
- そのユーザーのmypace投稿一覧
- マソンリーレイアウトで表示（タイムラインと同じ）

### 長文の折りたたみ
- タイムライン上では420文字または42行を超える投稿は省略
- 「...続きを読む」表示
- クリックで個別投稿ページへ遷移して全文表示

## Settings Panel

右からスライドで開くパネル。パネル外クリックまたは右上の×ボタンで閉じる。
- **モバイル対応**: 画面幅いっぱいになる場合でも×ボタンで閉じられる

### タブ構成

2つのタブに分割:
- **Settings**: アプリ設定
- **About**: アプリ情報・シェア

タブボタンは八角形デザイン、非選択タブは `--surface-secondary` 背景色。

### Settings タブ

- **Profile**: 名前・アバター表示 + 「Edit Profile →」リンク
  - クリックでプロフィールページへ遷移して編集
- **App Theme**: ライト/ダークテーマ切り替え
  - LIGHT / DARK ボタン（八角形）
- **Window Color**: 4隅カラーカスタマイズ（即時保存）
- **Your Keys**: npub/nsec表示、コピー機能
  - nsecはデフォルト非表示（Show/Hideで切り替え）
- **Import Key**: nsecインポート
  - インポート時に既存設定（プロフィール、テーマ）をクリア
- **Danger Zone**: キー削除

### About タブ

- **Share App**: QRコード表示（アプリURL共有用）
- **Notice**: 免責事項
  - "This app is provided as-is without warranty. Use at your own risk."
  - "Images uploaded to Nostr cannot be deleted due to the protocol's design."
- **GitHub**: リポジトリへのリンク（フッター）

パネル開閉時にbodyのスクロールを無効化（二重スクロールバー防止）。

## App Theme (ライト/ダーク)

アプリ全体のUIテーマ。Window Color（背景）とは独立。

### ライトテーマ（デフォルト）
- 投稿フォーム背景: `#fff`
- 入力欄背景: `#f5f5f5`
- テキスト: `#333`
- ボタン: 黒背景白文字

### ダークテーマ
- 投稿フォーム背景: `#1a1a1a`
- 入力欄背景: `#333`
- テキスト: `#e0e0e0`
- ボタン: 白背景黒文字（反転）

### 適用範囲
- Settingsパネル
- 投稿フォーム
- プロフィール設定フォーム
- ボタン類

### 適用されない要素
- ページ背景（Window Colorで制御）
- 投稿カード（各ユーザーのテーマカラー）

## Window Color (パーソナルカラー)

PS1 FF7のウィンドウカラーカスタマイズにインスパイアされた機能。

### 概要
- 4隅の色を指定し、中央でなめらかにブレンドするグラデーション背景
- **ページ全体の背景** と **自分の投稿カードの背景** の両方に適用
- 他のユーザーからも、その人の投稿カードとして色が見える

### UI
- プレビューエリア内に4つの円形カラーピッカーを配置
- 常に有効（Enable チェックボックスは廃止）
- 色変更時に即時保存・即時反映（Apply/Resetボタンなし）

### グラデーション生成
```css
radial-gradient(ellipse at top left, color1 0%, transparent 50%),
radial-gradient(ellipse at top right, color2 0%, transparent 50%),
radial-gradient(ellipse at bottom left, color3 0%, transparent 50%),
radial-gradient(ellipse at bottom right, color4 0%, transparent 50%),
linear-gradient(135deg, color1 0%, color4 100%)
```

### 自動テキスト色調整
4隅それぞれの色の明度を計算（WCAG準拠の相対輝度）し、要素の位置に応じて色を反転:

**全体的なテキスト色**:
- 4隅のうち2つ以上が暗い → 白文字（`light-text`）
- それ以外 → 黒文字（`dark-text`）
- ロゴ、Settingsボタン、投稿カードの本文に適用

**位置別の色調整**（投稿カード内）:
- **左上（タイムスタンプ）**: 左上の背景色に基づき反転（`corner-tl-dark`/`corner-tl-light`）
- **左下（反応ボタン）**: 半透明白背景を敷くことで常に視認可能（背景色による切り替え不要）
- 黒縁のある投稿者名は背景色に関係なく読めるため反転不要

### Nostrタグ
投稿時にテーマカラーをイベントタグとして埋め込み:
```
['mypace_theme', '#0a1628', '#1a3a5c', '#1a3a5c', '#0a1628']
```
- 本文のハッシュタグとは別（tags配列のメタデータ）
- 他のNostrクライアントでは無視される
- mypaceでのみグラデーションカードとして表示

### デフォルト色
テーマ無効時の背景色と同じ白系:
| 位置 | 色 |
|------|-----|
| 全て | `#f8f8f8` |

### プリセット: FF7風ブルー
| 位置 | 色 |
|------|-----|
| 左上 | `#0a1628` |
| 右上 | `#1a3a5c` |
| 左下 | `#1a3a5c` |
| 右下 | `#0a1628` |

### オーバースクロール対応
スマホで上下に引っ張った時も背景色が見えるよう、`html`要素にもテーマ色を適用。

## Image Upload

### アップロード方法
- 📷ボタンをクリックしてファイル選択
- 📷ボタンに画像をドラッグ&ドロップ

### 仕様
- **ホスティング**: nostr.build（NIP-98認証）
- **ファイルサイズ**: 最大5MB
- **対応形式**: 画像ファイル全般

### 注意事項
- アップロードした画像は削除できない（nostr.build仕様）
- 本文からURLを削除しても、画像自体はインターネット上に残る
- これはNostr/分散型SNSの特性

## Content Rendering

投稿内容の自動パース:
- **Markdown**: 見出し、太字、リスト、引用、コードブロック等（詳細は後述）
- **独自構文**: アライメント（`>>`等）、フォント（`<font>`）（詳細は「Custom Syntax」セクション参照）
- **ハッシュタグ**: 青紫色で表示、クリックでフィルタリング（日本語対応）
- **URL**: 緑色リンク、新しいタブで開く
- **画像URL** (`.jpg`, `.png`, `.gif`, `.webp`, `.svg`): インライン画像表示
- **カスタム絵文字**: `:shortcode:` 形式を絵文字画像に変換（NIP-30）

### カスタム絵文字（NIP-30）
- プロフィールや投稿イベントの `emoji` タグから定義を取得
- ユーザー名・投稿本文・投稿プレビューで表示
- 絵文字はインライン画像として表示（高さ1.2em）

### LightBox

画像クリック時にLightBoxモーダルで拡大表示:
- 背景: 半透明黒（`rgba(0,0,0,0.9)`）
- ESCキーまたは背景クリックで閉じる
- 右上に×ボタン
- 画像クリック領域は画像のみ（親要素への伝播を防止）
- 表示中はbodyスクロールを無効化

## Rich Embeds

投稿内のURLを検出し、リッチな埋め込みコンテンツとして表示。

### 対応タイプ

| タイプ | 対応URL | 表示方法 |
|--------|---------|----------|
| YouTube | youtube.com, youtu.be | サムネイル → クリックで動画再生 |
| YouTube Shorts | youtube.com/shorts/ | 縦型レイアウトで動画再生 |
| Twitter/X | twitter.com, x.com | react-tweetでリッチ表示 |
| Instagram | instagram.com/p/, /reel/ | 投稿・リール埋め込み |
| TikTok | tiktok.com/@user/video/ | 動画埋め込み |
| Spotify | open.spotify.com/track等 | 曲・アルバム・プレイリスト・ポッドキャスト |
| 動画 | .mp4, .webm, .ogg, .mov | HTML5 videoプレイヤー |
| ゲーム/デモ | github.io, itch.io等 | クリックでiframe読み込み |
| OGP | その他URL | タイトル・説明・画像のカード |

### YouTube埋め込み
- サムネイル画像を先に表示（遅延読み込み）
- 中央に再生ボタン（赤いYouTubeスタイル）
- クリックでプライバシー強化モード埋め込み（`youtube-nocookie.com`）

### YouTube Shorts埋め込み
- 縦型アスペクト比（9:16）で表示
- 最大幅320px、中央配置
- サムネイル + 「Shorts」バッジ表示
- クリックで動画再生

### Twitter/X埋め込み
- react-tweetライブラリを使用したリッチ表示
- API経由でツイートデータを取得（Syndication API）
- ダーク/ライトテーマ自動切り替え
- 読み込み失敗時はリンクフォールバック

### Instagram埋め込み
- 投稿（/p/）とリール（/reel/）に対応
- ストーリーはリンク表示のみ（24時間で消えるため）
- 公式埋め込みiframeを使用
- リールは縦型レイアウト

### TikTok埋め込み
- 公式embed.jsを使用
- 短縮URL（vm.tiktok.com）にも対応
- クリックで読み込み開始

### Spotify埋め込み
- 対応コンテンツ: track, album, playlist, episode, show
- コンテンツタイプに応じた高さ調整（単曲152px、アルバム等352px）
- Spotifyブランドカラーのプレースホルダー

### ゲーム/デモ埋め込み（iFrame）
- セキュリティのため許可ドメインのみ対応:
  - `github.io` - GitHub Pages
  - `itch.io`, `itch.zone` - ゲーム配布
  - `codepen.io`, `codesandbox.io`, `jsfiddle.net` - コード共有
  - `glitch.me` - Glitchプロジェクト
  - `vercel.app`, `netlify.app`, `pages.dev` - ホスティング
- `sandbox`属性で権限制限:
  - `allow-scripts` - スクリプト実行
  - `allow-same-origin` - 同一オリジン
  - `allow-pointer-lock` - ポインターロック（ゲーム用）
  - ❌ `allow-top-navigation` - 親ページ操作を禁止
  - ❌ `allow-popups` - ポップアップ禁止
- クリックで読み込み開始（自動読み込みなし）
- 「Open in new tab」リンク付き

### OGPリンクプレビュー
- `/api/ogp` エンドポイントでメタデータ取得
- 取得情報: `og:title`, `og:description`, `og:image`, `og:site_name`
- Twitter Card (`twitter:*`) もフォールバックとして使用
- 画像+テキストのカード形式で表示
- 取得失敗時はシンプルなリンク表示

### 表示位置
- 投稿本文の下、アクションボタンの上に表示
- 複数URLがある場合は縦に並べて表示
- 画像URLは埋め込み対象外（インライン画像として別処理）

## Header Filter

ヘッダー右上に統合されたフィルタボタン。

### フィルタアイコン
- アイコンの枠: 常に黒（#333）
- アイコンの中身: 通常は白、フィルタ適用時は水色（--action-reply: #3498db）
- **アクティブ判定**: mypace only ON、言語フィルタ設定、NGワード/NGタグ設定、OKワード/OKタグ設定のいずれかがあればアクティブ

### FilterPanel
「Filter」ボタンをクリックすると、すぐ下にポップアップでフィルタUIが表示される:

#### mypaceトグル（最上部）
- **MY PACE**: #mypace投稿のみ表示（トグル、右寄せ）
- サーバーサイドフィルタのため最上部に配置

#### OKグループ
- **OK word**: 投稿内容またはユーザー名に含まれるキーワードで検索（虫眼鏡アイコン）
- **OK tags**: 指定ハッシュタグを含む投稿のみ表示（チェックマークアイコン、緑色）
  - ホワイトスペースまたはカンマ区切りで複数指定可能
  - 大文字小文字を区別しない
  - AND/ORモード切り替え可能

#### NGグループ
- **NG word**: 投稿内容またはユーザー名に指定キーワードを含む投稿を非表示（禁止アイコン、赤色）
  - ホワイトスペースまたはカンマ区切りで複数指定可能
  - 大文字小文字を区別しない
- **NG tags**: 指定ハッシュタグを含む投稿を非表示（禁止アイコン、赤色）
  - ホワイトスペースまたはカンマ区切りで複数指定可能

#### 言語フィルタ
- **言語選択**: ドロップダウンで言語選択（最下部）

### フィルタ操作
- **保存ボタン**: 右下の「Save」で設定を保存
  - 変更がある場合は赤いドットインジケータを表示
- **解除ボタン**: 「Clear」でデフォルト設定にリセット（mypace only=ON, その他すべて空）
- **インクリメンタル検索なし**: 設定変更は即時反映せず、保存ボタン押下時のみ
- **Enterキー**: 保存と同じ動作
- **Escapeキー**: ポップアップを閉じる（変更は破棄）
- **サーバーフィルタ変更時**: mypaceトグル変更後のSave時は、タイムラインを消去してローディングから再読み込み

フィルタ適用でホームページ（`/`）のURLパラメータが更新される。

### モバイル対応
- 狭い画面では「Filter」ラベルを非表示にしアイコンのみ
- ポップアップは画面幅に収まるよう`max-width: calc(100vw - 2rem)`

## Language Filter

言語でフィルタリング可能。

### 対応言語
- Japanese (ja)
- English (en)
- Chinese (zh)
- Korean (ko)
- Spanish (es)
- French (fr)
- German (de)

### 言語判定ロジック
投稿内容の文字種で判定（簡易判定、上から順に評価）:
1. 日本語: ひらがな・カタカナがあれば日本語
2. 韓国語: ハングル
3. 中国語: 漢字のみ（ひらがな・カタカナがない）
4. スペイン語: áéíóúüñ¿¡
5. フランス語: àâçéèêëîïôùûü（ßなし）
6. ドイツ語: äöüß
7. 英語: 上記以外（デフォルト）

**注意**: 漢字は日本語と中国語で共通のため、ひらがな・カタカナの有無で区別する。

### ユーザー主要言語の考慮

英語は共通語として特別扱いされる。

**非英語フィルタ（日本語、韓国語等）の場合**:
- その言語の投稿を表示
- **加えて**、その言語で主に投稿するユーザーの英語のみの投稿も表示

例: 日本語フィルタ時、普段日本語で投稿するユーザーが英語だけで書いた投稿も表示される。

**英語フィルタの場合**:
- 英語投稿のみ表示
- 他言語は混ぜない

理由: 英語圏のユーザーは多言語が混じることを望まないため。

### 主要言語の判定
ユーザーの投稿履歴から、英語以外で最も多い言語を「主要言語」と判定。
英語以外の投稿がない場合は主要言語なし（英語ネイティブとみなす）。

## Hashtag Filtering

- ハッシュタグクリックでフィルタリングモード
- 複数タグのAND/OR絞り込みに対応
- フィルタはFilterPanelポップアップで管理（ヘッダー右上のフィルタボタンから開く）
- OKタグ欄に選択中のタグが表示され、個別に削除可能（`×`ボタン）
- AND/ORボタンでモードを切り替え
- 「Clear」で全フィルター解除
- ロゴクリックでもホームに戻る
- mypaceタグ付き投稿の中からさらに絞り込み（mypace ONの場合）

### 複数タグフィルタURL

| URL | 意味 |
|-----|------|
| `/?tags=javascript` | javascriptタグのみ |
| `/?tags=javascript+react` | javascript AND react |
| `/?tags=javascript,react` | javascript OR react |
| `/tag/javascript` | （レガシー）javascriptタグのみ |

### 操作

1. ハッシュタグをクリック → OKタグに追加（FilterPanelに反映）
2. FilterPanelでAND/ORボタンをクリック → モード切り替え
3. FilterPanelでタグの×ボタン → そのタグのみ解除
4. 「Clear」 → 全フィルター解除してデフォルトに戻る

## Markdown & Code Highlighting

プログラマー向け機能として、投稿内容はMarkdownとしてパースされる:

### 改行の扱い
- 単一の改行も`<br>`として反映される（`breaks: true`）
- 一般ユーザーの期待通りに表示される

### 対応Markdown記法
- **見出し**: `# H1`, `## H2`, `### H3`
- **太字/斜体**: `**bold**`, `*italic*`
- **リスト**: `- item` / `1. item`
- **引用**: `> quote`
- **リンク**: `[text](url)`
- **インラインコード**: `` `code` ``
- **コードブロック**: ` ```lang ... ``` `

### シンタックスハイライト (Prism.js)
コードブロックは言語指定でシンタックスハイライト:

対応言語:
- JavaScript / TypeScript / JSX / TSX
- Python / Rust / Go
- CSS / JSON / YAML
- Bash / SQL / Markdown

### コードブロックスタイル
- VS Code風ダークテーマ
- 背景: `#1e1e1e`
- フォント: `JetBrains Mono`, `Fira Code` 等のコード用フォント
- 横スクロール対応

### インラインコードスタイル
- 背景: `#f0f0f0`
- テキスト: `#c7254e` (ピンク系)
- 角丸: `3px`

## Custom Syntax (独自構文)

Markdownに加えて、mypace独自の構文をサポート。HTMLタグに似た形式だが、独自パーサーで処理される。

### アライメント構文

行頭に配置して、テキストの配置を制御:

| 構文 | 効果 | 例 |
|------|------|-----|
| `<< text` | 左寄せ | `<< 左に寄せる` |
| `>> text` | 右寄せ | `>> 右に寄せる` |
| `>< text` | 中央寄せ | `>< 真ん中` |
| `<> left \| right` | 左右分割 | `<> 左側 \| 右側` |

### フォント構文

`<font>` タグ風の構文で色とサイズを変更（HTMLタグではなく独自構文）:

```
<font color=red>赤い文字</font>
<font size=5>大きい文字</font>
<font color=#ff6600 size=4>オレンジで少し大きい</font>
```

#### 対応属性

| 属性 | 値 | 説明 |
|------|-----|------|
| `color` | 色名 or HEX | `red`, `blue`, `#ff0000` など |
| `size` | 1-5 | フォントサイズ（3が標準） |

#### 許可された色名
`red`, `blue`, `green`, `yellow`, `orange`, `purple`, `pink`, `cyan`, `magenta`, `lime`, `navy`, `teal`, `maroon`, `white`, `black`, `gray`, `grey`, `silver`

#### サイズマッピング
| size | 実際のサイズ |
|------|-------------|
| 1 | 0.5em |
| 2 | 0.75em |
| 3 | 1em（標準） |
| 4 | 1.5em |
| 5 | 2em |

### コードブロック内での挙動

コードブロック（` ``` `）やインラインコード（`` ` ``）内では、すべての独自構文がそのまま表示される:

```
>> これは右寄せにならず、そのまま表示される
<font color=red>これも色が変わらず、そのまま表示される</font>
```

これにより、プログラミングコード内の `>>` や `<` が誤って解釈されることを防ぐ。

### 処理順序

コンテンツは以下の順序で処理される:

1. **コードブロック抽出** - ` ``` ` と `` ` `` を保護
2. **アライメント抽出** - `>>`, `<<`, `><`, `<>` をプレースホルダーに
3. **HTMLサニタイズ** - すべての `<` `>` をエスケープ（セキュリティ）
4. **Markdownパース** - `marked` ライブラリで変換
5. **アライメント復元** - プレースホルダーを `<div>` に変換
6. **フォント構文処理** - エスケープ済み `&lt;font&gt;` を `<span style="...">` に変換
7. **その他の処理** - 画像URL、リンク、ハッシュタグ、カスタム絵文字
8. **コードブロック復元** - 保護していたコードを元に戻す

この順序により:
- セキュリティ: すべてのHTMLが例外なくエスケープされる
- コードブロック保護: コード内の構文は処理されない
- 独自構文: Markdownとは別レイヤーで安全に処理

## Draft Auto-Save

投稿フォームの内容は自動的にlocalStorageに保存される:

- **保存キー**: `mypace_draft`
- **保存タイミング**: テキスト入力のたびに自動保存
- **復元**: ページ読み込み時に下書きがあれば自動復元
- **削除**: 投稿成功時（`newpost`イベント発火時）に自動削除

長文作成中のブラウザクラッシュや誤操作からの保護。

## Performance Optimization

### 初回ロード高速化
- 投稿データ取得後すぐに表示（Loading解除）
- プロファイル、リアクション、返信データは並列で非同期取得
- リポストは背景で取得し、後からマージ

### 個別投稿ページのキャッシュ
- タイムラインから投稿クリック時、sessionStorageにイベントデータをキャッシュ
- 個別投稿ページでキャッシュがあれば即座に表示
- リレーからの再取得は背景で実行

## Constants

アプリ全体で使用する定数は`app/lib/nostr/events.ts`で管理:

| 定数 | 値 | 用途 |
|------|-----|------|
| `MYPACE_TAG` | `mypace` | 投稿に付与するハッシュタグ |
| `APP_TITLE` | `MY★PACE` | ページタイトル |
