# スーパーメンション（万物への言及）

> **「万物の擬人化」** - ハンチョウに「面白かったで」、酸素に「いつもありがとう」と呼びかける

## 概要

`@@` 構文を使って、この世のあらゆるものに対してコメントできる機能。

通常のメンション `@user` が人への呼びかけなら、スーパーメンション `@@` は万物への呼びかけ。

```
@@ハンチョウ

宮本さんのセリフ、ぐっときた

#mypace
```

## 構文

```
@@対象
```

- `@@` で始まる（ダブルアットマーク）
- UTF-8 文字列（日本語OK）
- スペースは使用不可（代わりにハイフンかアンダースコア）

## Nostrタグへの変換

投稿時、スーパーメンションは `t` タグに変換される。

**投稿内容:**
```
@@ハンチョウ

20巻の宮本さん、最高だった
```

**Nostrイベント:**
```json
{
  "kind": 1,
  "content": "@@ハンチョウ\n\n20巻の宮本さん、最高だった",
  "tags": [
    ["t", "mypace"],
    ["t", "/ハンチョウ"]
  ]
}
```

- `t` タグを使用（既存のNostr仕様に準拠）
- 他のNostrクライアントでもタグとして表示される

## 表示

投稿カードにはスーパーメンションが強調表示される。

```
┌────────────────────────────────────┐
│ @username · 2時間前                 │
│                                    │
│ @@ハンチョウ (Q12345678)            │  ← 強調表示 + Qバッジ
│                                    │
│ 20巻の宮本さん、最高だった          │
│                                    │
│ ★★★                               │
└────────────────────────────────────┘
```

`@@` 部分が太字・黄色で表示され、クリックでフィルタリング可能。

確定済みのスーパーメンションにはQ番号バッジが表示される（例: `(Q12345678)`）。

### Q番号バッジのWikipediaリンク

Q番号バッジはクリック可能で、対応するWikipediaページを新しいタブで開く。

```
https://ja.wikipedia.org/wiki/Special:GoToLinkedPage/jawiki/{Q番号}
```

- サジェストポップアップ内のQ番号バッジ → クリックでWikipediaを開く
- 投稿本文内のQ番号バッジ → クリックでWikipediaを開く
- Wikipedia URLはOGPカード表示の対象外（プレビューカードは表示されない）

## サジェストUI

エディタ上部の `@@` ボタンをクリックするか、エディタ内で `@@` と入力すると、ポップアップでサジェストが表示される。

```
┌─────────────────────────────────────────────────────────┐
│ @@ [検索...]                                            │
├─────────────────────────────────────────────────────────┤
│ [Check] ハンチョウ [Q12345678] 1日外出録ハンチョウ       │ ← Q確定済み
│ [Search] 班長 [Q99999999] カイジの登場人物               │ ← Wikidata候補
│ [PenLine] ハンチョウ  新規作成                           │
└─────────────────────────────────────────────────────────┘
```

- 検索は部分一致（「無限城」で「鬼滅の刃 無限城編」がヒット）
- Escでポップアップを閉じる
- 履歴とWikidataから直接検索

### サジェストアイコン

| アイコン | 意味 |
|----------|------|
| Check | Q番号が確定済みの履歴 |
| Pin | Q番号未確定の履歴 |
| Search | Wikidata検索結果 |
| PenLine | 新規作成（カスタムパス） |

### Q番号の表示

- サジェスト候補にQ番号がバッジ表示される（例: `[Q12345678]`）
- ホバーでtooltipにも `Wikidata: Q12345678` と表示
- クリックでWikipediaを開く

### Q番号の訂正

誤ったQ番号が紐付いた場合:

1. 同じパスを入力（例: `@@ハンチョウ`）
2. 履歴とWikidata候補が両方表示される
3. 正しいWikidata候補を選択
4. Q番号が上書きされる

※ 常にWikidata検索が実行されるため、いつでも訂正可能

## Wikidataマッピング

スーパーメンションはWikidata Q番号と紐付けて管理される。

```sql
CREATE TABLE super_mention_paths (
  path TEXT PRIMARY KEY,              -- "/ハンチョウ"
  category TEXT,                      -- (レガシー、現在は未使用)
  wikidata_id TEXT,                   -- "Q123456789" (nullable)
  wikidata_label TEXT,                -- "1日外出録ハンチョウ"
  wikidata_description TEXT,          -- "日本の漫画作品"
  use_count INTEGER DEFAULT 1,
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL
);
```

**API エンドポイント:**

- `GET /api/wikidata/search?q=ハンチョウ&lang=ja` - Wikidata検索
- `GET /api/super-mention/suggest?prefix=ハンチョウ` - サジェスト取得
- `POST /api/super-mention/paths` - パス保存（使用時に自動）

## 将来の拡張

### URL参照

URLへの言及も `@@` 構文で対応予定:

```
@@example.com/article/123
```

### 検索

特定の対象についての投稿を検索:

```
/posts?ref=/ハンチョウ
```

### Q番号による正規化

同じ作品の表記ゆれを統一:
- `@@ハンチョウ` → Q番号で正規化
- `@@1日外出録ハンチョウ` → 同じQ番号

## 設計思想

### なぜ `@@` か

- `@` は人へのメンション
- `@@` は「スーパー」メンション（万物への呼びかけ）
- WikidataのQ番号でフラットに管理するため、階層構造（`/`）は不要

### はてブとの違い

- はてブ: URLのあるものだけ
- mypace: 万物（URLがなくてもOK）

### タグ乱立の解決

- サジェストで収束を促す
- 使用数が多いパスが上位に
- Q番号で同じ対象を識別

### 万物の擬人化

`@@` はメンション（呼びかけ）。作品や概念に対して「語りかける」ニュアンス。

```
@@酸素

いつもありがとう
```
