# スマートフィルタ

サーバーサイドで広告/NSFWコンテンツを自動フィルタリングする機能。

## 概要

タイムライン取得時にサーバー側で不要なコンテンツを除外する。クライアント側のフィルタ（OKワード、NGワード等）とは別に、サーバー側で効率的にフィルタリングを行う。

## フィルタ項目

| 項目 | デフォルト | 説明 |
|------|-----------|------|
| Hide Ads | ON | 広告・スパム・仮想通貨関連を非表示 |
| Hide NSFW | ON | 成人向けコンテンツを非表示 |

## 検出方法

### 広告フィルタ（Hide Ads）

| 方法 | 内容 | 効果 |
|------|------|------|
| タグ検出 | `bitcoin`, `btc`, `crypto`, `eth`, `ethereum`, `airdrop`, `nft`, `ad`, `sponsored`, `giveaway`, `promo` | 高 |
| キーワード | `airdrop`, `giveaway`, `free btc`, `free bitcoin` | 中 |
| URL数 | 11個以上のURLを含む投稿 | 高 |

### NSFWフィルタ（Hide NSFW）

| 方法 | 内容 | 効果 |
|------|------|------|
| タグ検出 | `nsfw`, `r18`, `r-18`, `adult`, `sensitive`, `nude`, `porn`, `xxx`, `hentai`, `content-warning` | 高 |
| キーワード | なし（理由は下記参照） | - |

## 設計思想

### タグベースを重視

Nostrでは投稿者が自らタグを付ける慣習がある:

- **広告投稿者**: `#bitcoin`, `#airdrop` 等を自ら付けて拡散を狙う
- **NSFW投稿者**: NIP-36準拠で `content-warning` タグを付ける責任ある投稿者が多い

### キーワード検出は控えめに

- 「投資」「仮想通貨」等の一般的な単語は誤検出が多い
- 「18禁」「エロ」等は**責任ある投稿者が警告として使う言葉**であり、実際のスパマーは使わない
- キーワードは明らかなスパムフレーズ（`airdrop`, `giveaway`）のみに限定

### URL数カウント

- 大量のリンクを含む投稿はスパムの可能性が高い
- 閾値: 10個まではOK、11個以上でスパム判定
- 長文投稿での参考リンク程度は許容

## UI

FilterPanel内の回路図UIとOKワード入力の間に配置:

```
┌─────────────────────────────────┐
│ [Preset(3) ▼] [💾] [🗑️]        │
├─────────────────────────────────┤
│ (回路図: SNS/Blog/Mypace)       │
├─────────────────────────────────┤
│ [Smart Filter ▼]                │  ← クリックでポップアップ
│ ┌─────────────────────────────┐ │
│ │ [✓] 💵 Hide Ads             │ │
│ │ [✓] 👁️ Hide NSFW            │ │
│ │ [🌐 Language ▼]             │ │
│ └─────────────────────────────┘ │
├─────────────────────────────────┤
│ OK Word: [          ]           │
│ OK Tags: [          ]           │
│ ...                             │
└─────────────────────────────────┘
```

- ラベルクリックでトグル切替
- 言語フィルタもこのポップアップ内に配置

## 保存方法

フィルタ設定は **localStorage** に保存され、APIリクエスト時にパラメータとして送信。
ブラウザURLには含まれない（共有URLに個人設定が漏れない）。

デフォルトはON（非表示）。

### 言語フィルタの初期値

初回アクセス時（localStorageがない状態）は、**ブラウザの言語設定**を自動検出して言語フィルタの初期値として使用する。

- `navigator.language` から言語コード（`ja`, `en`等）を取得
- サポート言語（`ja`, `en`, `zh`, `ko`, `es`, `fr`, `de`）に含まれていればその言語でフィルタ
- 含まれていなければ「All Languages」

localStorageはApplyするまで作成されない（プライバシー配慮）。

## API

```
GET /api/timeline?hideAds=0&hideNSFW=0
```

| パラメータ | デフォルト | 説明 |
|-----------|-----------|------|
| `hideAds` | `1` | `0`で広告を表示 |
| `hideNSFW` | `1` | `0`でNSFWを表示 |

## 実装ファイル

| ファイル | 役割 |
|----------|------|
| `apps/api/src/filters/smart-filter.ts` | サーバーサイドフィルタロジック |
| `apps/api/src/routes/timeline.ts` | タイムラインAPI（フィルタ適用） |
| `apps/web/src/components/filter/FilterPanel.tsx` | UI |
| `apps/web/src/lib/api/api.ts` | APIクライアント（パラメータ送信） |
| `apps/web/src/hooks/timeline/useTimeline.ts` | フィルタパラメータ受け渡し |
| `apps/web/src/types/index.ts` | SearchFilters型 |

## 将来の拡張

現在の実装はシンプルなタグ・キーワード・URL数ベース。より高度なフィルタリングが必要になった場合:

1. **ML APIベースの検出**: [nostr-filter-relay](https://github.com/atrifat/nostr-filter-relay) のようなML APIを使用
2. **クラスタリング検出**: [Nostr.Band](https://spam.nostr.band/) のような類似メッセージのクラスタリング
3. **レピュテーションシステム**: 信頼スコアベースのフィルタリング

現時点ではタグベースで十分機能しており、複雑化は見送り。
